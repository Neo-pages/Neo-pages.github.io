<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Epsilon Wallet</title>
<script src="https://cdn.jsdelivr.net/npm/tweetnacl/nacl.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tweetnacl-util/nacl-util.min.js"></script>
<style>
body { font-family: sans-serif; max-width: 600px; margin: 2em auto; }
button { margin: 0.5em 0; }
input { width: 100%; margin: 0.5em 0; padding: 0.5em; }
#log { white-space: pre-wrap; background: #eee; padding: 1em; margin-top: 1em; height: 200px; overflow-y: auto; }
</style>
</head>
<body>

<h1>Epsilon 0 Wallet</h1>

<button id="createWallet">Create New Wallet</button>
<button id="loadWallet">Load Wallet</button>
<button id="exportWallet">Export Wallet</button>

<h3>Wallet Address:</h3>
<div id="address">None</div>

<h3>Balance:</h3>
<div id="balance">0</div>
<button id="checkBalance">Check Balance</button>

<h3>Send Epsilon:</h3>
<input type="text" id="recipient" placeholder="Recipient Address">
<input type="number" id="amount" placeholder="Amount">
<button id="send">Send</button>

<div id="log"></div>

<script>
const NODE = "http://127.0.0.1:8080"; // change to your server

let wallet = null; // will hold { sk, pk }

function log(msg) { document.getElementById('log').innerText += msg + "\n"; }

// convert keys
function hexToBytes(hex) {
    const bytes = new Uint8Array(hex.length / 2);
    for (let i = 0; i < hex.length; i += 2) {
        bytes[i/2] = parseInt(hex.substr(i,2),16);
    }
    return bytes;
}
function bytesToHex(bytes) {
    return Array.from(bytes).map(b => b.toString(16).padStart(2,'0')).join('');
}

// Create new wallet
document.getElementById("createWallet").onclick = () => {
    const keyPair = nacl.sign.keyPair();
    wallet = {
        sk: keyPair.secretKey,
        pk: keyPair.publicKey
    };
    document.getElementById("address").innerText = bytesToHex(wallet.pk);
    log("New wallet created!");
};

// Load wallet (paste hex secret key)
document.getElementById("loadWallet").onclick = () => {
    const skHex = prompt("Paste your secret key (64 bytes hex):");
    if(!skHex || skHex.length !== 128) { log("Invalid key"); return; }
    const skBytes = hexToBytes(skHex);
    wallet = {
        sk: skBytes,
        pk: skBytes.slice(32,64) // tweetnacl secretKey: last 32 bytes are public
    };
    document.getElementById("address").innerText = bytesToHex(wallet.pk);
    log("Wallet loaded!");
};
async function sendHeartbeat() {
    if (!wallet) return;
    try {
        await fetch(NODE + "/heartbeat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ address: bytesToHex(wallet.pk) })
        });
    } catch (e) {
        log("Heartbeat failed");
    }
}

// Send heartbeat every 5 seconds
setInterval(sendHeartbeat, 5000);
// Export wallet
document.getElementById("exportWallet").onclick = () => {
    if(!wallet) { log("No wallet loaded"); return; }
    const blob = new Blob([bytesToHex(wallet.sk)], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "epsilon_wallet.txt";
    a.click();
    log("Wallet exported!");
};

// Check balance
document.getElementById("checkBalance").onclick = async () => {
    if(!wallet) { log("No wallet loaded"); return; }
    const addr = bytesToHex(wallet.pk);
    try {
        const r = await fetch(`${NODE}/wallets`);
        const wallets = await r.json();
        document.getElementById("balance").innerText = wallets[addr]?.balance||0;
        log("Balance updated");
    } catch(e) { log("Failed to fetch balance"); }
};

// Send transaction
document.getElementById("send").onclick = async () => {
    if(!wallet) { log("No wallet loaded"); return; }
    const recipient = document.getElementById("recipient").value.trim();
    const amount = parseInt(document.getElementById("amount").value);
    if(!recipient || isNaN(amount)) { log("Invalid recipient or amount"); return; }

    const msg = new TextEncoder().encode(bytesToHex(wallet.pk)+recipient+amount);
    const sig = bytesToHex(nacl.sign.detached(msg, wallet.sk));

    try {
        const r = await fetch(`${NODE}/send`, {
            method:"POST",
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ sender: bytesToHex(wallet.pk), recipient, amount, signature: sig })
        });
        const text = await r.text();
        log("Send response: "+text);
    } catch(e) { log("Failed to send transaction"); }
};
</script>

</body>
</html>
